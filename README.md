# 動画前処理ビューアー アプリケーション

このアプリケーションは、動画のシーンや字幕データを管理し、プレビュー、エクスポート、削除を行うためのツールです。
FlaskバックエンドAPIとStreamlitフロントエンドで構成されています。

## 機能概要

*   **データ表示:** SQLiteデータベースに格納された動画、シーン、字幕データをAgGridで一覧表示します。
*   **フィルタリング:** ファイル名、シーン説明、字幕内容でデータを絞り込み検索できます。
*   **単一シーンプレビュー:** グリッド内の再生ボタンをクリックすると、該当シーンの動画をプレビュー表示します（動画ファイルが必要です）。
*   **連続再生:** グリッドで選択した複数のシーンを連続して再生します（動画ファイルが必要です）。
*   **エクスポート:**
    *   **CSV:** グリッドで選択した行データをCSVファイルとしてダウンロードします。
    *   **SRT:** 選択した行に関連する字幕データをSRTファイル形式でダウンロードします。
    *   **EDL:** 選択した行のシーンデータをCMX 3600形式のEDLファイルとしてダウンロードします。
*   **シーン削除:** グリッドで選択したシーンをデータベースから削除します（確認ダイアログあり）。

## セットアップと実行

### 必要なもの

*   Python 3.8以上
*   必要なPythonライブラリ (Flask, Streamlit, Pandas, Requests, st-aggridなど)
*   SQLiteデータベースファイル (`video_data.db`)
*   動画ファイルとサムネイル画像が格納されたベースフォルダ

### インストール

1.  **リポジトリのクローンまたはファイルの展開:**
    ```bash
    # git clone <repository_url> # もしGitリポジトリがあれば
    # cd video_preview_app
    # または
    # unzip video_preview_app.zip
    # cd video_preview_app
    ```

2.  **必要なライブラリのインストール:**
    (もし `requirements.txt` があれば)
    ```bash
    pip install -r requirements.txt
    ```
    (なければ、個別にインストール)
    ```bash
    pip install Flask Flask-Cors pandas requests streamlit streamlit-aggrid
    ```

3.  **データベースファイルの配置:**
    `video_data.db` ファイルをアプリケーションのルートディレクトリ（`app.py` や `streamlit_app.py` がある場所）に配置します。

4.  **動画・サムネイルフォルダの準備:**
    データベース内の `videos.filepath` や `scenes.thumbnail_path` で参照されている動画ファイルやサムネイル画像が格納されたフォルダを用意します。このフォルダのパスを後でサーバー起動時に指定します。

### 実行

1.  **バックエンドサーバーの起動:**
    ターミナルを開き、アプリケーションのルートディレクトリで以下のコマンドを実行します。
    `<path_to_your_media_folder>` を実際の動画・サムネイルフォルダのパスに置き換えてください。
    ```bash
    python app.py --base-folder <path_to_your_media_folder> --db video_data.db
    ```
    デフォルトでは `http://localhost:5000` で起動します。

2.  **フロントエンドサーバーの起動:**
    別のターミナルを開き、同じくアプリケーションのルートディレクトリで以下のコマンドを実行します。
    ```bash
    streamlit run streamlit_app.py
    ```
    デフォルトでは `http://localhost:8501` で起動します。

3.  **アクセス:**
    Webブラウザで `http://localhost:8501` を開きます。

## 使い方

### データ表示とフィルタリング

*   起動すると、データベース内のすべてのシーンと関連データがメインエリアのテーブル（AgGrid）に表示されます。
*   サイドバーの「絞り込み」セクションにあるテキストボックスにキーワードを入力すると、ファイル名、シーン説明、字幕内容でリアルタイムに絞り込みが行われます。

### シーンの選択

*   テーブルの各行の左側にあるチェックボックスを使って、シーンを選択できます。
*   Shiftキーを押しながらチェックボックスをクリックすると、範囲選択が可能です。
*   テーブルヘッダーのチェックボックスで、現在表示されている（フィルタリングされた）すべての行を選択/解除できます。
*   サイドバーの「選択情報」セクションで、選択中の行数と合計時間（シーンの尺）を確認できます。

### 単一シーンプレビュー

*   テーブルの「プレビュー」列にある「▶ 再生」ボタンをクリックします。
*   右側（または上部）のプレビューエリアに動画プレーヤーとシーン情報が表示され、該当シーンの開始時間から動画が再生されます。
*   プレビューエリアの「プレビューを閉じる」ボタンでプレビューを終了します。
*   **注意:** この機能を利用するには、バックエンド起動時に指定したベースフォルダ内に、データベースで参照されている動画ファイルが正しく配置されている必要があります。

### 連続再生

1.  テーブルで連続再生したいシーンを複数選択します。
2.  サイドバーの「アクション」>「連続再生」セクションにある「選択項目を連続再生」ボタンをクリックします。
3.  プレビューエリアに動画プレーヤーが表示され、選択したシーンが（動画ファイルごと、開始時間の昇順でソートされた後）順番に再生されます。
4.  再生中は、サイドバーに現在の再生状況（再生中、一時停止、終了など）と、再生中のシーン番号（例: 3 / 10）が表示されます。
5.  「再生停止」ボタンで連続再生を中断できます。
6.  **注意:** この機能を利用するには、バックエンド起動時に指定したベースフォルダ内に、データベースで参照されている動画ファイルが正しく配置されている必要があります。

### エクスポート

1.  テーブルでエクスポートしたいシーンを選択します。
2.  サイドバーの「アクション」>「エクスポート」セクションで、エクスポートしたい形式（CSV, SRT, EDL）を選択します。
3.  対応するダウンロードボタン（例: 「選択項目をSRTダウンロード」）をクリックします。
4.  ファイルが生成され、ブラウザ経由でダウンロードが開始されます。
    *   **CSV:** 選択された行のテーブルデータがそのままCSV形式で出力されます。
    *   **SRT:** 選択された行に関連する字幕データ（`transcriptions`テーブル）がSRT形式で出力されます。
    *   **EDL:** 選択された行のシーンデータ（`scenes`テーブル）がCMX 3600形式のEDLとして出力されます。リール名は動画ファイル名（拡張子なし、8文字まで）が使用され、フレームレートは30fps（ノン-ドロップフレーム）と仮定されます。

### シーン削除

1.  テーブルで削除したいシーンを選択します。
2.  サイドバーの「アクション」>「シーン削除」セクションにある「選択項目を削除」ボタンをクリックします。
3.  確認メッセージが表示されるので、再度「はい、削除します」ボタンをクリックします。
4.  選択されたシーンがデータベースから削除され、テーブルが自動的に更新されます。
5.  **注意:** この操作は元に戻せません。削除されるのは `scenes` テーブルのレコードのみで、関連する動画ファイルやサムネイルファイル、`transcriptions` テーブルのレコードは削除されません。

## 技術詳細

*   **バックエンド:** Flask
    *   SQLiteデータベースとの接続とデータ取得
    *   動画ファイルのストリーミング配信
    *   サムネイル画像の配信
    *   SRT/EDLファイル生成API
    *   シーン削除API
*   **フロントエンド:** Streamlit
    *   AgGridコンポーネント (`streamlit-aggrid`) によるインタラクティブなテーブル表示
    *   `st.components.v1.html` とJavaScriptを用いたカスタム動画プレーヤーによる連続再生制御
    *   バックエンドAPIとの連携 (`requests`)
    *   ファイルダウンロード機能 (`st.download_button`)

## 既知の問題・制限事項

*   動画ファイルがない場合、単一シーンプレビューおよび連続再生機能は動作しません（UIは表示される場合があります）。
*   EDL出力は30fps（ノン-ドロップフレーム）を前提としています。異なるフレームレートの動画を扱う場合は、タイムコード変換部分の修正が必要です。
*   大量のデータを扱う場合、フロントエンドのパフォーマンスに影響が出る可能性があります。


